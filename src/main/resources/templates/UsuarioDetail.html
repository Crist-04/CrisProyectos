<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Detalle de Usuario</title>

    <th:block layout:fragment="extra-css">
        <style>
            body {
                background: #ffffff;
                min-height: 100vh;
                padding: 40px 20px;
            }

            .container-main {
                max-width: 1200px;
                margin: 0 auto;
            }

            .page-header {
                text-align: center;
                color: #667eea;
                margin-bottom: 40px;
            }

            .page-header h1 {
                font-size: 2.5rem;
                font-weight: 700;
            }

            .page-header p {
                color: #666;
            }

            .card-custom {
                background: white;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                margin-bottom: 30px;
                overflow: hidden;
                transition: transform 0.3s ease;
            }

            .card-custom:hover {
                transform: translateY(-5px);
            }

            .card-header-custom {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px 30px;
                font-size: 1.3rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .card-header-custom i {
                font-size: 1.5rem;
            }

            .card-body-custom {
                padding: 30px;
            }

            .user-avatar {
                width: 120px;
                height: 120px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 3rem;
                color: white;
                margin: 0 auto 20px;
                border: 5px solid white;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }

            .user-name {
                text-align: center;
                font-size: 1.8rem;
                font-weight: 700;
                color: #333;
                margin-bottom: 10px;
            }

            .user-role {
                text-align: center;
                font-size: 1rem;
                color: #666;
                margin-bottom: 20px;
            }

            .user-role .badge {
                padding: 8px 20px;
                font-size: 0.9rem;
            }

            .info-section {
                display: none;
                animation: fadeIn 0.5s;
            }

            .info-section.show {
                display: block;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .info-row {
                display: flex;
                padding: 15px 0;
                border-bottom: 1px solid #e9ecef;
                align-items: center;
            }

            .info-row:last-child {
                border-bottom: none;
            }

            .info-label {
                font-weight: 600;
                color: #667eea;
                width: 200px;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .info-label i {
                font-size: 1.2rem;
            }

            .info-value {
                color: #333;
                flex: 1;
            }

            .form-control {
                border: 2px solid #e9ecef;
                border-radius: 8px;
                padding: 10px 15px;
                transition: all 0.3s;
            }

            .form-control:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            }

            .form-control:disabled {
                background-color: #f8f9fa;
                cursor: not-allowed;
            }

            .form-select {
                border: 2px solid #e9ecef;
                border-radius: 8px;
                padding: 10px 15px;
                transition: all 0.3s;
            }

            .form-select:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            }

            .btn-custom {
                padding: 12px 30px;
                border-radius: 10px;
                font-weight: 500;
                transition: all 0.3s;
                border: none;
            }

            .btn-primary-custom {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .btn-primary-custom:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }

            .btn-success-custom {
                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                color: white;
            }

            .btn-success-custom:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
            }

            .btn-warning-custom {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
            }

            .btn-warning-custom:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
            }

            .btn-secondary-custom {
                background: linear-gradient(135deg, #a8a8a8 0%, #707070 100%);
                color: white;
            }

            .btn-secondary-custom:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(112, 112, 112, 0.4);
            }

            .btn-danger-custom {
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
                color: white;
            }

            .btn-danger-custom:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
            }

            .address-card {
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                border-radius: 15px;
                padding: 20px;
                margin-bottom: 20px;
                position: relative;
                overflow: hidden;
            }

            .address-card::before {
                content: "";
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
                pointer-events: none;
            }

            .address-number {
                position: absolute;
                top: 10px;
                right: 15px;
                background: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                color: #667eea;
                box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            }

            .address-info {
                position: relative;
                z-index: 1;
            }

            .address-info p {
                margin-bottom: 12px;
                color: #333;
            }

            .address-info strong {
                color: #667eea;
            }

            .no-addresses {
                text-align: center;
                padding: 40px;
                color: #666;
            }

            .no-addresses i {
                font-size: 4rem;
                color: #ccc;
                margin-bottom: 20px;
            }

            .action-buttons {
                display: flex;
                gap: 15px;
                justify-content: center;
                flex-wrap: wrap;
                margin-top: 20px;
            }

            .edit-mode-indicator {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
                padding: 10px 20px;
                border-radius: 10px;
                text-align: center;
                margin-bottom: 20px;
                font-weight: 600;
                display: none;
            }

            .edit-mode-indicator.active {
                display: block;
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%, 100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.8;
                }
            }
        </style>
    </th:block>
</head>
<body layout:fragment="content">
    <div class="container-main">
        <div class="page-header">
            <h1><i class="bi bi-person-circle"></i> Detalle del Usuario</h1>
            <p>Informaci√≥n completa del perfil</p>
        </div>

        <!-- usuario-->
        <form th:object="${usuario}" th:action="@{/usuario/detalle}" method="post" id="userForm">
            <input type="hidden" name="idUsuario" th:value="${usuario.idUsuario}">

            <div class="card-custom">
                <div class="card-header-custom">
                    <i class="bi bi-person-badge"></i>
                    <span>Informaci√≥n del Usuario</span>
                </div>
                <div class="card-body-custom">
                    <div class="edit-mode-indicator" id="editModeIndicator">
                        <i class="bi bi-pencil-square"></i> MODO EDICI√ìN ACTIVADO
                    </div>

                    <div class="user-avatar" th:if="${usuario.Imagen != null && !usuario.Imagen.isEmpty()}">
                        <img th:src="'data:image/png;base64,' + ${usuario.Imagen}" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" 
                             alt="Foto de perfil">
                    </div>
                    <div class="user-avatar" th:if="${usuario.Imagen == null || usuario.Imagen.isEmpty()}">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div class="user-name" id="displayName" th:text="${usuario.nombre + ' ' + usuario.apellidoPaterno + ' ' + usuario.apellidoMaterno}">
                        Nombre Completo
                    </div>
                    <div class="user-role">
                        <span class="badge bg-primary" id="displayRole" th:text="${usuario.rol.nombreRol}">Rol</span>
                    </div>

                    <div class="text-center mb-3">
                        <button type="button" class="btn btn-primary-custom btn-custom" onclick="toggleInfo()">
                            <i class="bi bi-eye" id="toggleIcon"></i>
                            <span id="toggleText">Mostrar Informaci√≥n Completa</span>
                        </button>
                    </div>

                    <div class="info-section" id="infoSection">
                        <hr class="my-4">

                        <h5 class="mb-3" style="color: #667eea; font-weight: 600;">
                            <i class="bi bi-person-lines-fill"></i> Datos Personales
                        </h5>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-person"></i>
                                <span>Nombre:</span>
                            </div>
                            <div class="info-value">
                                <input type="text" class="form-control" name="nombre" 
                                       th:value="${usuario.nombre}" disabled id="nombre">
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-person"></i>
                                <span>Apellido Paterno:</span>
                            </div>
                            <div class="info-value">
                                <input type="text" class="form-control" name="apellidoPaterno" 
                                       th:value="${usuario.apellidoPaterno}" disabled id="apellidoPaterno">
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-person"></i>
                                <span>Apellido Materno:</span>
                            </div>
                            <div class="info-value">
                                <input type="text" class="form-control" name="apellidoMaterno" 
                                       th:value="${usuario.apellidoMaterno}" disabled id="apellidoMaterno">
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-person-badge"></i>
                                <span>Username:</span>
                            </div>
                            <div class="info-value">
                                <input type="text" class="form-control" name="userName" 
                                       th:value="${usuario.userName}" disabled id="userName">
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-credit-card"></i>
                                <span>CURP:</span>
                            </div>
                            <div class="info-value">
                                <input type="text" class="form-control" name="CURP" 
                                       th:value="${usuario.CURP}" disabled id="CURP" maxlength="18">
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-calendar-event"></i>
                                <span>Fecha de Nacimiento:</span>
                            </div>
                            <div class="info-value">
                                <input type="date" class="form-control" name="fechaNacimiento" 
                                       th:value="${usuario.fechaNacimiento}" disabled id="fechaNacimiento">
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-gender-ambiguous"></i>
                                <span>Sexo:</span>
                            </div>
                            <div class="info-value">
                                <select class="form-select" name="sexo" disabled id="sexo">
                                    <option value="M" th:selected="${usuario.sexo == 'M'}">Masculino</option>
                                    <option value="F" th:selected="${usuario.sexo == 'F'}">Femenino</option>
                                </select>
                            </div>
                        </div>

                        <h5 class="mb-3 mt-4" style="color: #667eea; font-weight: 600;">
                            <i class="bi bi-telephone-fill"></i> Datos de Contacto
                        </h5>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-envelope"></i>
                                <span>Email:</span>
                            </div>
                            <div class="info-value">
                                <input type="email" class="form-control" name="Email" 
                                       th:value="${usuario.Email}" disabled id="Email">
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-telephone"></i>
                                <span>Tel√©fono:</span>
                            </div>
                            <div class="info-value">
                                <input type="tel" class="form-control" name="telefono" 
                                       th:value="${usuario.telefono}" disabled id="telefono" maxlength="10">
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-phone"></i>
                                <span>Celular:</span>
                            </div>
                            <div class="info-value">
                                <input type="tel" class="form-control" name="Celular" 
                                       th:value="${usuario.Celular}" disabled id="Celular" maxlength="10">
                            </div>
                        </div>

                        <h5 class="mb-3 mt-4" style="color: #667eea; font-weight: 600;">
                            <i class="bi bi-shield-check"></i> Datos de Cuenta
                        </h5>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-person-badge-fill"></i>
                                <span>Rol:</span>
                            </div>
                            <div class="info-value">
                                <select class="form-select" name="rol.idRol" disabled id="rol">
                                    <option value="1" th:selected="${usuario.rol.idRol == 1}">Administrador</option>
                                    <option value="2" th:selected="${usuario.rol.idRol == 2}">Usuario</option>
                                    <option value="3" th:selected="${usuario.rol.idRol == 3}">Cliente</option>
                                    <option value="4" th:selected="${usuario.rol.idRol == 4}">Rol5</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons mt-4">
                        <button type="button" class="btn btn-warning-custom btn-custom" id="editBtn" onclick="toggleEdit()">
                            <i class="bi bi-pencil-square"></i> <span id="editBtnText">Editar Usuario</span>
                        </button>

                        <button type="submit" class="btn btn-success-custom btn-custom" id="saveBtn" style="display: none;">
                            <i class="bi bi-check-circle"></i> Guardar Cambios
                        </button>

                        <button type="button" class="btn btn-secondary-custom btn-custom" onclick="window.location.href = '/usuario'">
                            <i class="bi bi-arrow-left-circle"></i> Volver al Listado
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- estas son para direcciones -->
        <!-- estas son para direcciones -->
<div class="card-custom" style="max-height: 500px; overflow-y: auto;">
    <div class="card-header-custom">
        <i class="bi bi-geo-alt-fill"></i>
        <span>Direcciones Registradas</span>
    </div>

    <div class="card-body-custom">
        <!-- Bot√≥n agregar direcci√≥n -->
        <div class="text-center mb-3">
            <button type="button" 
                    class="btn btn-success-custom btn-custom"
                    th:onclick="'prepararModalAgregar(' + ${usuario.idUsuario} + ')'">
                <i class="bi bi-plus-square-fill"></i> Agregar Nueva Direcci√≥n
            </button>
        </div>

        <!-- Tabla de direcciones -->
        <div th:if="${usuario.direcciones != null and !usuario.direcciones.isEmpty()}">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th class="col-1">#</th>
                        <th class="col-5">Direcci√≥n Completa</th>
                        <th class="col-2">C√≥digo Postal</th>
                        <th class="col-4 text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="direccion, iterStat : ${usuario.direcciones}">
                        <td th:text="${iterStat.count}">1</td>
                        <td>
                            <strong th:text="${direccion.calle}">Calle</strong><br>
                            <small class="text-muted">
                                No. Ext: <span th:text="${direccion.numeroExterior}">123</span>
                                <span th:if="${direccion.numeroInterior != null and !direccion.numeroInterior.isEmpty()}">
                                    , Int: <span th:text="${direccion.numeroInterior}">A</span>
                                </span>
                            </small><br>
                            <small class="text-muted">
                                <span th:text="${direccion.colonia.nombre}">Colonia</span>,
                                <span th:text="${direccion.colonia.municipio.nombre}">Municipio</span>,
                                <span th:text="${direccion.colonia.municipio.estado.nombre}">Estado</span>
                            </small>
                        </td>
                        <td>
                            <span class="badge bg-info" th:text="${direccion.colonia.codigoPostal}">00000</span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" 
                                        class="btn btn-primary-custom btn-sm"
                                        th:attr="
                                            data-id=${direccion.idDireccion},
                                            data-calle=${direccion.calle},
                                            data-numeroext=${direccion.numeroExterior},
                                            data-numeroint=${direccion.numeroInterior},
                                            data-colonia=${direccion.colonia.idColonia},
                                            data-municipio=${direccion.colonia.municipio.idMunicipio},
                                            data-estado=${direccion.colonia.municipio.estado.idEstado},
                                            data-idusuario=${usuario.idUsuario}"
                                        onclick="editarDireccion(this)">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>

                                <button type="button" 
                                        class="btn btn-danger-custom btn-sm"
                                        th:onclick="'eliminarDireccion(' + ${direccion.idDireccion} + ',' + ${usuario.idUsuario} + ')'">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Mensaje cuando no hay direcciones -->
        <div th:if="${usuario.direcciones == null or usuario.direcciones.isEmpty()}" 
             class="no-addresses">
            <i class="bi bi-house-x"></i>
            <h5>No hay direcciones registradas</h5>
            <p class="text-muted">Haz clic en "Agregar Nueva Direcci√≥n" para comenzar</p>
        </div>
    </div>
</div>
    </div>


    <!--Modal-->
    <div class="modal fade" id="modalAgregarDireccion" tabindex="-1" aria-labelledby="modalAgregarDireccionLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="modal-title" id="modalAgregarDireccionLabel">
                        <i class="bi bi-plus-circle"></i> Agregar Nueva Direcci√≥n
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <form id="formAgregarDireccion">
                        <input type="hidden" id="idUsuarioModal" name="idUsuario">

                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-signpost-2"></i> <strong>Calle:</strong></label>
                            <input type="text" class="form-control" name="calle" id="modalCalle" required>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-hash"></i> <strong>No. Exterior:</strong></label>
                                <input type="text" class="form-control" name="numeroExterior" id="modalNumeroExterior" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-hash"></i> <strong>No. Interior:</strong></label>
                                <input type="text" class="form-control" name="numeroInterior" id="modalNumeroInterior">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-globe"></i> <strong>Pa√≠s:</strong></label>
                                <select class="form-select" id="modalPais">
                                    <option value="0">Selecciona un pa√≠s</option>
                                    <option value="1" selected>M√©xico</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-map"></i> <strong>Estado:</strong></label>
                                <select class="form-select" id="modalEstado" required>
                                    <option value="0">Selecciona un estado</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-geo"></i> <strong>Municipio:</strong></label>
                                <select class="form-select" id="modalMunicipio" required>
                                    <option value="0">Selecciona un municipio</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-building"></i> <strong>Colonia:</strong></label>
                                <select class="form-select" id="modalColonia" name="colonia.idColonia" required>
                                    <option value="0">Selecciona una colonia</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-mailbox"></i> <strong>C√≥digo Postal:</strong></label>
                            <input type="text" class="form-control" id="modalCodigoPostal" readonly placeholder="Se cargar√° autom√°ticamente">
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary-custom btn-custom" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success-custom btn-custom" onclick="guardarNuevaDireccionModal()">
                        <i class="bi bi-check-circle"></i> Guardar Direcci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>  


   <!-- funciones para desbloquear los inputs y botones de direcciones -->
<th:block layout:fragment="extra-scripts">
    <script>
// ‚≠ê FUNCI√ìN MEJORADA para manejar propiedades con may√∫sculas
function getPropertyValue(obj, propName) {
    if (!obj) return undefined;
    
    // Intenta con el nombre original
    if (obj[propName] !== undefined) return obj[propName];
    
    // Intenta capitalizando la primera letra (IdEstado, Nombre, etc.)
    const capitalizedProp = propName.charAt(0).toUpperCase() + propName.slice(1);
    if (obj[capitalizedProp] !== undefined) return obj[capitalizedProp];
    
    // Intenta con min√∫sculas
    const lowerProp = propName.toLowerCase();
    if (obj[lowerProp] !== undefined) return obj[lowerProp];
    
    return undefined;
}

// ===== FUNCIONES PARA EL MODAL =====

function prepararModalAgregar(idUsuario) {
    console.log('üìù Preparando modal para agregar direcci√≥n');
    
    $("#modalAgregarDireccionLabel").html('<i class="bi bi-plus-circle"></i> Agregar Nueva Direcci√≥n');
    $("#btnTextoGuardar").text('Guardar Direcci√≥n');
    
    // Remover campo oculto de edici√≥n si existe
    if ($("#idDireccionModal").length) {
        $("#idDireccionModal").remove();
    }
    
    // Limpiar formulario
    $("#idUsuarioModal").val(idUsuario);
    $("#modalCalle").val("");
    $("#modalNumeroExterior").val("");
    $("#modalNumeroInterior").val("");
    $("#modalCodigoPostal").val("");
    
    // Resetear dropdowns
    $("#modalPais").val("1");
    $("#modalEstado").html("<option value='0'>Selecciona un estado</option>");
    $("#modalMunicipio").html("<option value='0'>Selecciona un municipio</option>");
    $("#modalColonia").html("<option value='0'>Selecciona una colonia</option>");
    
    // Cargar estados y configurar eventos
    cargarEstadosModal();
    configurarEventosModal();
    
    // Mostrar modal
    var modal = new bootstrap.Modal(document.getElementById('modalAgregarDireccion'));
    modal.show();
}

function editarDireccion(btn) {
    console.log('‚úèÔ∏è Preparando modal para editar direcci√≥n');
    
    const idDireccion = btn.dataset.id;
    const calle = btn.dataset.calle;
    const numExt = btn.dataset.numeroext;
    const numInt = btn.dataset.numeroint;
    const idColonia = btn.dataset.colonia;
    const idMunicipio = btn.dataset.municipio;
    const idEstado = btn.dataset.estado;
    const idUsuario = btn.dataset.idusuario;
    
    console.log('Datos a editar:', {idDireccion, calle, numExt, idEstado, idMunicipio, idColonia});
    
    $("#modalAgregarDireccionLabel").html('<i class="bi bi-pencil-square"></i> Editar Direcci√≥n');
    $("#btnTextoGuardar").text('Actualizar Direcci√≥n');
    
    // Crear campo oculto para el ID de direcci√≥n
    if (!$("#idDireccionModal").length) {
        const input = $('<input type="hidden" id="idDireccionModal" name="idDireccion">');
        $("#formAgregarDireccion").append(input);
    }
    
    $("#idDireccionModal").val(idDireccion);
    $("#idUsuarioModal").val(idUsuario);
    $("#modalCalle").val(calle);
    $("#modalNumeroExterior").val(numExt);
    $("#modalNumeroInterior").val(numInt || '');
    
    // Cargar cascada con valores actuales
    $("#modalPais").val("1");
    cargarEstadosModal(idEstado, idMunicipio, idColonia);
    configurarEventosModal();
    
    var modal = new bootstrap.Modal(document.getElementById('modalAgregarDireccion'));
    modal.show();
}

function cargarEstadosModal(idEstadoActual = null, idMunicipioActual = null, idColoniaActual = null) {
    console.log('üåé Cargando estados en modal...');
    
    $.ajax({
        type: 'GET',
        url: "/usuario/estado/1",
        dataType: "json",
        success: function(data) {
            console.log('‚úÖ Estados recibidos:', data);
            
            const ddlEstado = $("#modalEstado");
            ddlEstado.empty().append("<option value='0'>Selecciona un estado</option>");
            
            // ‚≠ê MANEJO CORRECTO de la respuesta (objects o object)
            const estados = data.objects || data.object || [];
            
            if (estados.length > 0) {
                $.each(estados, function(i, estado) {
                    const idEstado = getPropertyValue(estado, 'idEstado');
                    const nombre = getPropertyValue(estado, 'nombre');
                    ddlEstado.append(`<option value="${idEstado}">${nombre}</option>`);
                });
                
                // Si hay un estado actual, seleccionarlo y cargar sus municipios
                if (idEstadoActual && idEstadoActual != 0) {
                    ddlEstado.val(idEstadoActual);
                    cargarMunicipiosModal(idEstadoActual, idMunicipioActual, idColoniaActual);
                }
            } else {
                console.warn('‚ö†Ô∏è No se recibieron estados');
            }
        },
        error: function(xhr, status, error) {
            console.error('‚ùå Error cargando estados:', error);
            Swal.fire('Error', 'No se pudieron cargar los estados', 'error');
        }
    });
}

function cargarMunicipiosModal(idEstado, idMunicipioActual = null, idColoniaActual = null) {
    console.log('üèôÔ∏è Cargando municipios para estado:', idEstado);
    
    $.ajax({
        type: 'GET',
        url: "/usuario/municipio/" + idEstado,
        dataType: "json",
        success: function(data) {
            console.log('‚úÖ Municipios recibidos:', data);
            
            const ddlMunicipio = $("#modalMunicipio");
            ddlMunicipio.empty().append("<option value='0'>Selecciona un municipio</option>");
            
            // ‚≠ê MANEJO CORRECTO de la respuesta
            const municipios = data.objects || data.object || [];
            
            if (municipios.length > 0) {
                $.each(municipios, function(i, municipio) {
                    const idMunicipio = getPropertyValue(municipio, 'idMunicipio');
                    const nombre = getPropertyValue(municipio, 'nombre');
                    ddlMunicipio.append(`<option value="${idMunicipio}">${nombre}</option>`);
                });
                
                // Si hay un municipio actual, seleccionarlo y cargar sus colonias
                if (idMunicipioActual && idMunicipioActual != 0) {
                    ddlMunicipio.val(idMunicipioActual);
                    cargarColoniasModal(idMunicipioActual, idColoniaActual);
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('‚ùå Error cargando municipios:', error);
            Swal.fire('Error', 'No se pudieron cargar los municipios', 'error');
        }
    });
}

function cargarColoniasModal(idMunicipio, idColoniaActual = null) {
    console.log('üèòÔ∏è Cargando colonias para municipio:', idMunicipio);
    
    $.ajax({
        type: 'GET',
        url: "/usuario/colonia/" + idMunicipio,
        dataType: "json",
        success: function(data) {
            console.log('‚úÖ Colonias recibidas:', data);
            
            const ddlColonia = $("#modalColonia");
            ddlColonia.empty().append("<option value='0'>Selecciona una colonia</option>");
            
            // ‚≠ê MANEJO CORRECTO de la respuesta
            const colonias = data.objects || data.object || [];
            
            if (colonias.length > 0) {
                // Guardar colonias para obtener c√≥digo postal
                window.coloniasCargadas = colonias;
                
                $.each(colonias, function(i, colonia) {
                    const idColonia = getPropertyValue(colonia, 'idColonia');
                    const nombre = getPropertyValue(colonia, 'nombre');
                    ddlColonia.append(`<option value="${idColonia}">${nombre}</option>`);
                });
                
                // Si hay una colonia actual, seleccionarla
                if (idColoniaActual && idColoniaActual != 0) {
                    ddlColonia.val(idColoniaActual);
                    
                    // Cargar c√≥digo postal de la colonia seleccionada
                    const coloniaSeleccionada = colonias.find(c => 
                        getPropertyValue(c, 'idColonia') == idColoniaActual
                    );
                    
                    if (coloniaSeleccionada) {
                        const cp = getPropertyValue(coloniaSeleccionada, 'codigoPostal');
                        $("#modalCodigoPostal").val(cp);
                    }
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('‚ùå Error cargando colonias:', error);
            Swal.fire('Error', 'No se pudieron cargar las colonias', 'error');
        }
    });
}

function configurarEventosModal() {
    console.log('‚öôÔ∏è Configurando eventos del modal');
    
    // EVENTO: Cambio de Estado
    $("#modalEstado").off('change').on('change', function() {
        const idEstado = $(this).val();
        console.log('Estado cambiado a:', idEstado);
        
        if (idEstado != "0") {
            cargarMunicipiosModal(idEstado);
        } else {
            $("#modalMunicipio").html("<option value='0'>Selecciona un municipio</option>");
            $("#modalColonia").html("<option value='0'>Selecciona una colonia</option>");
            $("#modalCodigoPostal").val("");
        }
    });
    
    // EVENTO: Cambio de Municipio
    $("#modalMunicipio").off('change').on('change', function() {
        const idMunicipio = $(this).val();
        console.log('Municipio cambiado a:', idMunicipio);
        
        if (idMunicipio != "0") {
            cargarColoniasModal(idMunicipio);
        } else {
            $("#modalColonia").html("<option value='0'>Selecciona una colonia</option>");
            $("#modalCodigoPostal").val("");
        }
    });
    
    // EVENTO: Cambio de Colonia (actualizar c√≥digo postal)
    $("#modalColonia").off('change').on('change', function() {
        const idColonia = parseInt($(this).val());
        console.log('Colonia cambiada a:', idColonia);
        
        if (idColonia && idColonia != 0 && window.coloniasCargadas) {
            const coloniaSeleccionada = window.coloniasCargadas.find(c => 
                getPropertyValue(c, 'idColonia') == idColonia
            );
            
            if (coloniaSeleccionada) {
                const cp = getPropertyValue(coloniaSeleccionada, 'codigoPostal');
                $("#modalCodigoPostal").val(cp);
                console.log('C√≥digo postal:', cp);
            }
        } else {
            $("#modalCodigoPostal").val("");
        }
    });
}

function guardarNuevaDireccionModal() {
    const idDireccion = $("#idDireccionModal").val();
    const calle = $("#modalCalle").val().trim();
    const numeroExterior = $("#modalNumeroExterior").val().trim();
    const numeroInterior = $("#modalNumeroInterior").val().trim();
    const idColonia = $("#modalColonia").val();
    const idUsuario = $("#idUsuarioModal").val();
    
    // Validaciones
    if (!calle || !numeroExterior || !idColonia || idColonia == "0") {
        Swal.fire({
            title: 'Campos incompletos',
            text: 'Por favor completa todos los campos obligatorios',
            icon: 'warning'
        });
        return;
    }
    
    console.log('üíæ Guardando direcci√≥n:', {idDireccion, calle, numeroExterior, idColonia, idUsuario});
    
    // Preparar datos
    const formData = new FormData();
    if (idDireccion) formData.append('idDireccion', idDireccion);
    formData.append('idUsuario', idUsuario);
    formData.append('calle', calle);
    formData.append('numeroExterior', numeroExterior);
    formData.append('numeroInterior', numeroInterior);
    formData.append('colonia.idColonia', idColonia);
    
    // Determinar URL y m√©todo
    const url = idDireccion ? '/usuario/direccion/update' : '/usuario/direccion/add';
    
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalAgregarDireccion'));
    modal.hide();
    
    // Mostrar loading
    Swal.fire({
        title: idDireccion ? 'Actualizando...' : 'Guardando...',
        text: 'Por favor espera',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });
    
    // Enviar petici√≥n
    $.ajax({
        type: 'POST',
        url: url,
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            Swal.fire({
                title: '¬°√âxito!',
                text: idDireccion ? 'Direcci√≥n actualizada correctamente' : 'Direcci√≥n agregada correctamente',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            }).then(() => {
                location.reload();
            });
        },
        error: function(xhr, status, error) {
            console.error('‚ùå Error guardando direcci√≥n:', error);
            Swal.fire({
                title: 'Error',
                text: 'No se pudo guardar la direcci√≥n: ' + error,
                icon: 'error'
            });
        }
    });
}

function eliminarDireccion(idDireccion, idUsuario) {
    Swal.fire({
        title: '¬øEst√°s seguro?',
        text: "Esta direcci√≥n se eliminar√° permanentemente",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Eliminando...',
                text: 'Por favor espera',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            $.ajax({
                type: 'POST',
                url: '/usuario/direccion/delete',
                data: { idDireccion: idDireccion },
                success: function(response) {
                    if (response.correct) {
                        Swal.fire({
                            title: '¬°Eliminada!',
                            text: 'La direcci√≥n ha sido eliminada',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', response.errorMessage || 'No se pudo eliminar', 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error eliminando direcci√≥n:', error);
                    Swal.fire('Error', 'No se pudo eliminar la direcci√≥n', 'error');
                }
            });
        }
    });
}

// ===== FUNCIONES PARA EDICI√ìN DE USUARIO =====

let isEditMode = false;

function toggleInfo() {
    const infoSection = document.getElementById('infoSection');
    const toggleText = document.getElementById('toggleText');
    const toggleIcon = document.getElementById('toggleIcon');
    
    if (infoSection.classList.contains('show')) {
        infoSection.classList.remove('show');
        toggleText.textContent = 'Mostrar Informaci√≥n Completa';
        toggleIcon.className = 'bi bi-eye';
    } else {
        infoSection.classList.add('show');
        toggleText.textContent = 'Ocultar Informaci√≥n';
        toggleIcon.className = 'bi bi-eye-slash';
    }
}

function toggleEdit() {
    isEditMode = !isEditMode;
    const editBtn = document.getElementById('editBtn');
    const editBtnText = document.getElementById('editBtnText');
    const saveBtn = document.getElementById('saveBtn');
    const editModeIndicator = document.getElementById('editModeIndicator');
    const inputs = document.querySelectorAll('#infoSection input, #infoSection select');
    
    if (isEditMode) {
        inputs.forEach(input => input.disabled = false);
        editBtn.className = 'btn btn-secondary-custom btn-custom';
        editBtnText.innerHTML = 'Cancelar';
        saveBtn.style.display = 'inline-block';
        editModeIndicator.classList.add('active');
        
        if (!document.getElementById('infoSection').classList.contains('show')) {
            toggleInfo();
        }
    } else {
        inputs.forEach(input => input.disabled = true);
        editBtn.className = 'btn btn-warning-custom btn-custom';
        editBtnText.innerHTML = '<i class="bi bi-pencil-square"></i> Editar Usuario';
        saveBtn.style.display = 'none';
        editModeIndicator.classList.remove('active');
        location.reload();
    }
}

// Actualizar nombre en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    const nombreInput = document.getElementById('nombre');
    const apellidoPaternoInput = document.getElementById('apellidoPaterno');
    const apellidoMaternoInput = document.getElementById('apellidoMaterno');
    const displayName = document.getElementById('displayName');
    
    function updateDisplayName() {
        if (isEditMode) {
            const nombre = nombreInput.value || '';
            const paterno = apellidoPaternoInput.value || '';
            const materno = apellidoMaternoInput.value || '';
            displayName.textContent = `${nombre} ${paterno} ${materno}`.trim();
        }
    }
    
    if (nombreInput && apellidoPaternoInput && apellidoMaternoInput) {
        nombreInput.addEventListener('input', updateDisplayName);
        apellidoPaternoInput.addEventListener('input', updateDisplayName);
        apellidoMaternoInput.addEventListener('input', updateDisplayName);
    }
});
</script>

    <!-- Alertas -->
    <script th:if="${successMessage}" th:inline="javascript">
        Swal.fire({
            title: "¬°√âxito!",
            text: [[${successMessage}]],
            icon: "success",
            draggable: true
        });
    </script>

    <script th:if="${errorMessage}" th:inline="javascript">
        Swal.fire({
            title: "Error",
            text: [[${errorMessage}]],
            icon: "error",
            draggable: true
        });
    </script>
</th:block>
</body>
</html>